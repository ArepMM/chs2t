#include "dako.h"

//------------------------------------------------------------------------------
//
//------------------------------------------------------------------------------
Dako::Dako(QObject* parent) : Device(parent)
  , V0(0.0005)
  , V1(0.0005)
  , U1(40.0)
  , U6(80.0)
  , wheel_r(0.625)
  , w1(U1 / Physics::kmh / wheel_r)
  , w1_cur(0.0)
  , w6(U6 / Physics::kmh / wheel_r)
  , w6_cur(0.0)
  , I(100.0)
  , Ia(0.0)
  , pFL(0.0)
  , pBC(0.0)
  , QFL(0.0)
  , QBC(0.0)
  , A1(0.71)
  , A2(1.0)
  , K1(0.0)
  , K2(0.0)
  , K3(0.0)
  , K4(0.0)
  , K5(0.0)
  , K6(0.0)
  , k_1(0.0)
  , k_2(0.0)
  , k_3(0.0)
  , k_4(0.0)
  , release_valve_state(false)
  , EDT_state(false)
{

}

//------------------------------------------------------------------------------
//
//------------------------------------------------------------------------------
Dako::~Dako()
{

}

//------------------------------------------------------------------------------
//
//------------------------------------------------------------------------------
void Dako::setWheelRadius(double value)
{
    wheel_r = value;
    w1 = U1 / wheel_r / Physics::kmh;
    w6 = U6 / wheel_r / Physics::kmh;
}

//------------------------------------------------------------------------------
//
//------------------------------------------------------------------------------
void Dako::setAngularVelocity1(double value)
{
    w1_cur = abs(value);
}

//------------------------------------------------------------------------------
//
//------------------------------------------------------------------------------
void Dako::setAngularVelocity6(double value)
{
    w6_cur = abs(value);
}

//------------------------------------------------------------------------------
//
//------------------------------------------------------------------------------
void Dako::setEDTcurrent(double value)
{
    Ia = abs(value);
}

//------------------------------------------------------------------------------
//
//------------------------------------------------------------------------------
void Dako::setFLpressure(double value)
{
    pFL = value;
}

//------------------------------------------------------------------------------
//
//------------------------------------------------------------------------------
double Dako::getFLflow() const
{
    return QFL;
}

//------------------------------------------------------------------------------
//
//------------------------------------------------------------------------------
void Dako::setBCpressure(double value)
{
    pBC = value;
}

//------------------------------------------------------------------------------
//
//------------------------------------------------------------------------------
double Dako::getBCflow() const
{
    return QBC;
}

//------------------------------------------------------------------------------
//
//------------------------------------------------------------------------------
void Dako::setLocoCranePressure(double value)
{
    pKVT = value;
}

//------------------------------------------------------------------------------
//
//------------------------------------------------------------------------------
void Dako::setAirDistPressure(double value)
{
    pAD = value;
}

//------------------------------------------------------------------------------
//
//------------------------------------------------------------------------------
bool Dako::isPneumoBrakesRelease() const
{
    return release_valve_state;
}

//------------------------------------------------------------------------------
//
//------------------------------------------------------------------------------
bool Dako::isEDTAllow() const
{
    return EDT_state;
}

//------------------------------------------------------------------------------
//
//------------------------------------------------------------------------------
void Dako::ode_system(const state_vector_t& Y, state_vector_t& dYdt, double t)
{
    Q_UNUSED(t)

    // Управление нижней камерой от центробежного регулятора на шестой оси
    double s0 = w6_cur - w6;

    // Наполнение нижней камеры вслед за давлением от КВТ и экстренного торможения
    double Q0 = cut(k_3 * s0, 0.0, K3) * (pKVT - Y[DACO_BOTTOM_CAMERA]);
    // Опорожнение нижней камеры
    double Q0_atm = cut(-k_4 * s0, 0.0, K4) * Y[DACO_BOTTOM_CAMERA];

    // Управление средней камерой от отпускного клапана
    double s1 = static_cast<double>(release_valve_state);

    // Наполнение средней камеры вслед за давлением от воздухораспределителя
    double Q1 = (1.0 - s1) * K5 * (pAD - Y[DACO_MIDDLE_CAMERA]);
    // Опорожнение средней камеры
    double Q1_atm = s1 * K6 * Y[DACO_MIDDLE_CAMERA];

    dYdt[DACO_BOTTOM_CAMERA] = (Q0 - Q0_atm) / V0;

    dYdt[DACO_MIDDLE_CAMERA] = (Q1 - Q1_atm) / V1;

    DebugMsg = QString("pKVT%1|pAD%2|pBC%3|p0%4|p1%5|s0%6|s1%7|sA%8|EDT%9|rel%10")
            .arg(pKVT, 8, 'f', 5)
            .arg(pAD, 8, 'f', 5)
            .arg(pBC, 8, 'f', 5)
            .arg(getY(0), 8, 'f', 5)
            .arg(getY(1), 8, 'f', 5)
            .arg(s0, 6, 'f', 3)
            .arg(s1, 6, 'f', 3)
            .arg(A1 * Y[DACO_BOTTOM_CAMERA] + A2 * Y[DACO_MIDDLE_CAMERA] - pBC, 6, 'f', 3)
            .arg(EDT_state)
            .arg(release_valve_state);
}

//------------------------------------------------------------------------------
//
//------------------------------------------------------------------------------
void Dako::preStep(state_vector_t& Y, double t)
{
    Q_UNUSED(Y)
    Q_UNUSED(t)

    // Равновесие диафрагм - условное положение центрального штока
    double sA = A1 * Y[DACO_BOTTOM_CAMERA] + A2 * Y[DACO_MIDDLE_CAMERA] - pBC;
    // Поток на наполнение ТЦ из питательной магистрали
    double Q_fl_bc = cut(k_1 * sA, 0.0, K1) * (pFL - pBC);
    // Поток на опорожнение ТЦ в атмосферу
    double Q_bc_atm = cut(-k_2 * sA, 0.0, K2) * pBC;

    // Поток в тормозные цилиндры
    QBC = Q_fl_bc - Q_bc_atm;

    // Поток в питательную магистраль
    QFL = -Q_fl_bc;

    // Разрешение реостатного тормоза от центробежного регулятора на первой оси
    EDT_state = (w1_cur >= w1);

    // Разрешение отпуска пневматического тормоза при токе реостата более 100 А
    release_valve_state = (Ia >= I);
}

//------------------------------------------------------------------------------
//
//------------------------------------------------------------------------------
void Dako::load_config(CfgReader& cfg)
{
    QString secName = "Device";

    cfg.getDouble(secName, "V0", V0);
    cfg.getDouble(secName, "V1", V1);

    cfg.getDouble(secName, "U1", U1);
    cfg.getDouble(secName, "U6", U6);
    w1 = U1 / wheel_r / Physics::kmh;
    w6 = U6 / wheel_r / Physics::kmh;

    cfg.getDouble(secName, "I", I);

    cfg.getDouble(secName, "A1", A1);
    cfg.getDouble(secName, "A2", A2);

    cfg.getDouble(secName, "K1", K1);
    cfg.getDouble(secName, "K2", K2);
    cfg.getDouble(secName, "K3", K3);
    cfg.getDouble(secName, "K4", K4);
    cfg.getDouble(secName, "K5", K5);
    cfg.getDouble(secName, "K6", K6);

    cfg.getDouble(secName, "k1", k_1);
    cfg.getDouble(secName, "k2", k_2);
    cfg.getDouble(secName, "k3", k_3);
    cfg.getDouble(secName, "k4", k_4);
}
